<!doctype html>
<meta charset="utf-8" />
<title>一下 · Once</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link href="DSEG7Classic-Regular.woff2" rel="preload" as="font" type="font/woff2" crossorigin>
<style>
  @font-face{
    font-family:"DSEG7";
    src: url("DSEG7Classic-Regular.woff2") format("woff2");
    font-display: swap;
  }
  :root{
    --amber:#ffb300; --amber-glow:#ffab40; --panel:#0c0c0c; --panel-hi:#141414; --text-on:#ffd180;
    --ink:#cfd8dc; --sub:#9aa;
  }
  html,body{height:100%;margin:0;background:radial-gradient(1200px 800px at 50% 20%, #151515 0%, #000 70%);color:var(--ink)}
  .wrap{height:100%;display:grid;place-items:center;padding:24px}
  .device{width:min(720px,92vw);border-radius:24px;background:linear-gradient(180deg,#1e1e1e,#0b0b0b);
    box-shadow:inset 0 1px 0 rgba(255,255,255,.06),0 20px 60px rgba(0,0,0,.6);padding:28px;position:relative}
  .bezel{background:linear-gradient(180deg,var(--panel-hi),var(--panel));border-radius:18px;padding:18px;
    box-shadow:inset 0 0 0 1px rgba(255,255,255,.03),inset 0 -8px 24px rgba(0,0,0,.6)}
  /* 顶部灯 = 小时进位指示 */
  .lamps{position:absolute;left:32px;top:16px;display:flex;gap:10px}
  .lamp{width:12px;height:12px;border-radius:999px;background:#222;box-shadow:inset 0 0 0 1px rgba(255,255,255,.08)}
  .lamp.on{background:#ffb300; box-shadow:
      0 0 8px rgba(255,171,64,.75),
      0 0 18px rgba(255,171,64,.35),
      inset 0 0 0 1px rgba(255,255,255,.35)}
  .lcd{position:relative;border-radius:12px;background:linear-gradient(180deg,#0a0a0a,#111);padding:22px;overflow:hidden}
  .lcd::before{content:"";position:absolute;inset:0;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,.06),transparent 30%);pointer-events:none;mix-blend-mode:screen}
  .lcd::after{content:"";position:absolute;inset:-6%;border-radius:16px;background:radial-gradient(80% 60% at 50% 40%, rgba(255,179,0,.10), transparent 70%);
    filter:blur(6px);opacity:.6;transition:opacity .25s ease;pointer-events:none}
  .lcd.active::after{opacity:1}
  .row{display:flex;align-items:center;gap:12px;justify-content:space-between}
  .digits{flex:1;min-width:0;display:flex;align-items:baseline;gap:.2em;font-family:"DSEG7", ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    color:var(--text-on);text-shadow:0 0 12px rgba(255,171,64,.35),0 0 32px rgba(255,171,64,.22);
    letter-spacing:.04em;line-height:1;user-select:none;white-space:nowrap;font-size: clamp(48px, 14vw, 128px)}
  .sep{opacity:.9}
  .milli{font-size:.28em;filter:drop-shadow(0 0 6px rgba(255,171,64,.35))}
  .status{margin-top:8px;font-size:14px;color:var(--sub)}
  .bar{margin-top:16px;display:flex;gap:12px;align-items:center}
  button{
    -webkit-tap-highlight-color:transparent;cursor:pointer;border:0;border-radius:999px;padding:14px 22px;
    font:600 15px/1 system-ui, "Segoe UI", Helvetica, Arial, sans-serif}
  #toggle{background:linear-gradient(180deg,#ffb74d,#ff9800);color:#2b2100;box-shadow:0 6px 18px rgba(255,152,0,.25), inset 0 1px 0 rgba(255,255,255,.35)}
  .chip{margin-left:auto;display:inline-flex;align-items:center;gap:8px;background:#141414;color:#e0e0e0;
    border-radius:999px;padding:10px 14px;box-shadow:inset 0 0 0 1px rgba(255,255,255,.08)}
  .chip[aria-disabled="true"]{opacity:.6;pointer-events:none}
  .chip input{width:6em;background:transparent;border:0;outline:none;color:#fff;text-align:center;font:600 14px/1.1 system-ui}
  .chip .unit{opacity:.8}
  .note{margin-left:12px;color:#89a;font-size:13px}
</style>

<div class="wrap">
  <div class="device">
    <div class="lamps"><div id="lamp1" class="lamp"></div><div id="lamp2" class="lamp"></div><div id="lamp3" class="lamp"></div></div>
    <div class="bezel">
      <div id="lcd" class="lcd">
        <div class="row">
          <div id="digits" class="digits">
            <span id="mm">00</span><span class="sep">:</span><span id="ss">00</span><span class="milli">.<span id="d10">0</span></span>
          </div>
          <div id="chip" class="chip" title="点击编辑目标秒数">
            <span>目标</span>
            <input id="target" type="number" min="0" step="0.1" placeholder="—" inputmode="decimal">
            <span class="unit">s</span>
          </div>
        </div>
        <div id="status" class="status">待机 · 单键开始/停止（上限 3h，每小时亮一灯）</div>
      </div>

      <div class="bar">
        <button id="toggle">START</button>
        <div id="score" class="note">score: –</div>
        <div id="diff"  class="note">diff: –</div>
      </div>
    </div>
  </div>
</div>

<script>
  const capMs = 3 * 3600_000; // 最多3小时
  const HOUR = 3600_000;

  let running = false, t0 = 0, raf = 0, lastLap = null;

  const lcd = document.getElementById('lcd');
  const mmEl = document.getElementById('mm');
  const ssEl = document.getElementById('ss');
  const d10El = document.getElementById('d10');
  const status = document.getElementById('status');
  const toggle = document.getElementById('toggle');
  const chip = document.getElementById('chip');
  const target = document.getElementById('target');
  const score = document.getElementById('score');
  const diff = document.getElementById('diff');
  const lamps = [document.getElementById('lamp1'), document.getElementById('lamp2'), document.getElementById('lamp3')];

  const pad = (n)=> String(n).padStart(2,'0');

  function render(ms){
    const s = Math.floor(ms/1000);
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const sec = s%60;
    const d10 = Math.floor((ms%1000)/100);
    mmEl.textContent = pad(m);
    ssEl.textContent = pad(sec);
    d10El.textContent = d10;
    // 小时灯
    lamps.forEach((lamp,i)=>lamp.classList.toggle('on', h>i));
  }

  function evaluate(ms, targetSec){
    if(!targetSec || !isFinite(targetSec) || targetSec<=0) return null;
    const tgt = targetSec*1000;
    const r = Math.abs(ms - tgt) / tgt;
    const sigma = 0.05;
    const val = Math.exp(-0.5 * (r/sigma)*(r/sigma));
    const sc = Math.round(100*val);
    if(sc>=90) lcd.animate([{filter:'brightness(1.0)'},{filter:'brightness(1.2)'},{filter:'brightness(1.0)'}],{duration:420,easing:'ease-out'});
    return sc;
  }

  function tick(ts){
    if(!t0) t0 = ts;
    const elapsed = ts - t0;
    const total = Math.min(elapsed, capMs);
    render(total);
    if(elapsed >= capMs){ stopAt(total, true); return; }
    raf = requestAnimationFrame(tick);
  }

  function start(){
    running = true; t0 = performance.now();
    toggle.textContent = "STOP";
    lcd.classList.add('active');
    chip.setAttribute('aria-disabled','true');
    status.textContent = "计时中…";
    score.textContent = "score: –";
    diff.textContent  = "diff: –";
    cancelAnimationFrame(raf);
    raf = requestAnimationFrame(tick);
  }

  function stopAt(ms, hitCap=false){
    running = false;
    cancelAnimationFrame(raf);
    lcd.classList.remove('active');
    toggle.textContent = "START";
    chip.removeAttribute('aria-disabled');

    const sc = evaluate(ms, parseFloat(target.value));
    score.textContent = `score: ${sc ?? '–'}`;
    const d = (lastLap==null) ? "–" : `${((ms - lastLap)/1000).toFixed(2)}s`;
    diff.textContent = `diff: ${d}`;
    status.textContent = hitCap ? `到达上限 3h · 本次 ${(ms/1000).toFixed(2)}s` : `本次 ${(ms/1000).toFixed(2)}s`;
    lastLap = ms;
  }

  toggle.addEventListener('click', ()=>{
    if(!running){ start(); }
    else{
      const now = performance.now();
      const ms  = Math.min(now - t0, capMs);
      stopAt(ms);
    }
  });

  target.addEventListener('keydown', e=>{ if(e.key === 'Enter') target.blur(); });
  target.addEventListener('blur', ()=>{ const v = parseFloat(target.value); if(!(v>0)) target.value = ""; });

  render(0);
</script>
